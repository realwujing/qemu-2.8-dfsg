Commit-Id: c7ede54cbd2e2b25385325600958ba0124e31cc0
From: Ralf Haferkamp <rhafer@suse.com>
Date: Fri, 3 Jul 2020 14:51:16 +0200
Subject: Drop bogus IPv6 messages

Drop IPv6 message shorter than what's mentioned in the payload
length header (+ the size of the IPv6 header). They're invalid an could
lead to data leakage in icmp6_send_echoreply().
---
 slirp/ip6_input.c | 7 +++++++
 1 file changed, 7 insertions(+)

diff --git a/slirp/ip6_input.c b/slirp/ip6_input.c
index dfcbfd6..d88d1ab 100644
--- a/slirp/ip6_input.c
+++ b/slirp/ip6_input.c
@@ -49,6 +49,13 @@ void ip6_input(struct mbuf *m)
         goto bad;
     }
 
+    // Check if the message size is big enough to hold what's
+    // set in the payload length header. If not this is an invalid
+    // packet
+    if (m->m_len < ntohs(ip6->ip_pl) + sizeof(struct ip6)) {
+        goto bad;
+    }
+
     /* check ip_ttl for a correct ICMP reply */
     if (ip6->ip_hl == 0) {
         icmp6_send_error(m, ICMP6_TIMXCEED, ICMP6_TIMXCEED_INTRANS);
-- 
2.20.1

