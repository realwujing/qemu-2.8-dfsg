Origin: https://git.qemu.org/?p=qemu.git;a=commitdiff_plain;h=c2cb511634012344e3d0fe49a037a33b12d8a98a
Reviewed-by: Sylvain Beucler <beuc@debian.org>
Last-Update: 2021-02-10

From: Prasad J Pandit <pjp@fedoraproject.org>
Date: Wed, 11 Nov 2020 13:06:36 +0000 (+0530)
Subject: hw/net/e1000e: advance desc_offset in case of null descriptor
X-Git-Tag: v5.2.0-rc3~5^2~4
X-Git-Url: https://git.qemu.org/?p=qemu.git;a=commitdiff_plain;h=c2cb511634012344e3d0fe49a037a33b12d8a98a

hw/net/e1000e: advance desc_offset in case of null descriptor

While receiving packets via e1000e_write_packet_to_guest() routine,
'desc_offset' is advanced only when RX descriptor is processed. And
RX descriptor is not processed if it has NULL buffer address.
This may lead to an infinite loop condition. Increament 'desc_offset'
to process next descriptor in the ring to avoid infinite loop.

Reported-by: Cheol-woo Myung <330cjfdn@gmail.com>
Signed-off-by: Prasad J Pandit <pjp@fedoraproject.org>
Signed-off-by: Jason Wang <jasowang@redhat.com>
---

Index: qemu-2.8+dfsg/hw/net/e1000e_core.c
===================================================================
--- qemu-2.8+dfsg.orig/hw/net/e1000e_core.c
+++ qemu-2.8+dfsg/hw/net/e1000e_core.c
@@ -1595,13 +1595,13 @@ e1000e_write_packet_to_guest(E1000ECore
                           (const char *) &fcs_pad, e1000x_fcs_len(core->mac));
                 }
             }
-            desc_offset += desc_size;
-            if (desc_offset >= total_size) {
-                is_last = true;
-            }
         } else { /* as per intel docs; skip descriptors with null buf addr */
             trace_e1000e_rx_null_descriptor();
         }
+        desc_offset += desc_size;
+        if (desc_offset >= total_size) {
+            is_last = true;
+        }
 
         e1000e_write_rx_descr(core, desc, is_last ? core->rx_pkt : NULL,
                            rss_info, do_ps ? ps_hdr_len : 0, &bastate.written);
